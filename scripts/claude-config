#!/usr/bin/env python3
# ABOUTME: Manages enable/disable state for Claude Code skills, commands, agents, rules, and output-styles.
# ABOUTME: Uses relative symlinks from .library/ to discovery directories based on enabled.json config.

import json
import os
import sys
from pathlib import Path

CLAUDE_DIR = Path.home() / ".claude"
LIBRARY_DIR = CLAUDE_DIR / ".library"
CONFIG_FILE = CLAUDE_DIR / "enabled.json"

CATEGORIES = ["skills", "commands", "agents", "rules", "output-styles"]


def load_config() -> dict:
    """Load the enabled.json config file."""
    if not CONFIG_FILE.exists():
        return {cat: {} for cat in CATEGORIES}
    with open(CONFIG_FILE) as f:
        return json.load(f)


def save_config(config: dict) -> None:
    """Save the enabled.json config file."""
    with open(CONFIG_FILE, "w") as f:
        json.dump(config, f, indent=2)
        f.write("\n")


def get_library_items(category: str) -> list[str]:
    """Get all items in the library for a category."""
    lib_path = LIBRARY_DIR / category
    if not lib_path.exists():
        return []
    return sorted([p.name for p in lib_path.iterdir() if not p.name.startswith(".")])


def sync_category(category: str, config: dict) -> tuple[int, int]:
    """Sync a single category. Returns (enabled_count, disabled_count)."""
    target_dir = CLAUDE_DIR / category
    lib_dir = LIBRARY_DIR / category

    # Ensure target directory exists
    target_dir.mkdir(parents=True, exist_ok=True)

    # Get all items in library
    library_items = get_library_items(category)

    # Get enabled status from config, default to True for items not in config
    cat_config = config.get(category, {})

    enabled_count = 0
    disabled_count = 0

    # Remove existing symlinks (only symlinks, preserve any real files)
    for item in target_dir.iterdir():
        if item.is_symlink():
            item.unlink()

    # Create symlinks for enabled items (using relative paths for portability)
    for item_name in library_items:
        is_enabled = cat_config.get(item_name, True)  # Default to enabled

        if is_enabled:
            target = target_dir / item_name
            # Relative path: ../.library/{category}/{item}
            relative_source = Path("..") / ".library" / category / item_name
            target.symlink_to(relative_source)
            enabled_count += 1
        else:
            disabled_count += 1

    return enabled_count, disabled_count


def cmd_sync() -> None:
    """Sync all categories based on enabled.json config."""
    config = load_config()

    print("Syncing Claude Code configuration...")
    for category in CATEGORIES:
        enabled, disabled = sync_category(category, config)
        total = enabled + disabled
        if total > 0:
            print(f"  {category}: {enabled} enabled, {disabled} disabled")
        else:
            print(f"  {category}: (empty)")
    print("Done.")


def cmd_list(category: str | None = None) -> None:
    """List items and their enabled status."""
    config = load_config()

    categories_to_list = [category] if category else CATEGORIES

    for cat in categories_to_list:
        if cat not in CATEGORIES:
            print(f"Unknown category: {cat}")
            print(f"Valid categories: {', '.join(CATEGORIES)}")
            sys.exit(1)

        items = get_library_items(cat)
        cat_config = config.get(cat, {})

        if not items:
            print(f"\n{cat}/: (empty)")
            continue

        print(f"\n{cat}/:")
        for item in items:
            is_enabled = cat_config.get(item, True)
            status = "✓" if is_enabled else "✗"
            print(f"  {status} {item}")


def cmd_enable(category: str, item: str) -> None:
    """Enable an item."""
    if category not in CATEGORIES:
        print(f"Unknown category: {category}")
        sys.exit(1)

    config = load_config()

    # Handle wildcard
    if item == "*":
        items = get_library_items(category)
        if category not in config:
            config[category] = {}
        for i in items:
            config[category][i] = True
        save_config(config)
        sync_category(category, config)
        print(f"Enabled all {len(items)} items in {category}/")
        return

    # Check if item exists in library
    lib_path = LIBRARY_DIR / category / item
    if not lib_path.exists():
        print(f"Item not found in library: {category}/{item}")
        sys.exit(1)

    if category not in config:
        config[category] = {}
    config[category][item] = True
    save_config(config)
    sync_category(category, config)
    print(f"Enabled: {category}/{item}")


def cmd_disable(category: str, item: str) -> None:
    """Disable an item."""
    if category not in CATEGORIES:
        print(f"Unknown category: {category}")
        sys.exit(1)

    config = load_config()

    # Handle wildcard
    if item == "*":
        items = get_library_items(category)
        if category not in config:
            config[category] = {}
        for i in items:
            config[category][i] = False
        save_config(config)
        sync_category(category, config)
        print(f"Disabled all {len(items)} items in {category}/")
        return

    # Check if item exists in library
    lib_path = LIBRARY_DIR / category / item
    if not lib_path.exists():
        print(f"Item not found in library: {category}/{item}")
        sys.exit(1)

    if category not in config:
        config[category] = {}
    config[category][item] = False
    save_config(config)
    sync_category(category, config)
    print(f"Disabled: {category}/{item}")


def cmd_add(category: str, source_path: str) -> None:
    """Add a new item to the library from a source path.

    If source is a directory containing multiple items (subdirs or .md files),
    adds each item individually. Otherwise adds the source as a single item.
    """
    import shutil

    if category not in CATEGORIES:
        print(f"Unknown category: {category}")
        sys.exit(1)

    source = Path(source_path).expanduser().resolve()
    if not source.exists():
        print(f"Source not found: {source}")
        sys.exit(1)

    lib_dir = LIBRARY_DIR / category
    lib_dir.mkdir(parents=True, exist_ok=True)

    config = load_config()
    if category not in config:
        config[category] = {}

    # Determine if source is a single item or a container of multiple items
    items_to_add = []
    if source.is_dir():
        children = [c for c in source.iterdir() if not c.name.startswith(".")]

        # Check if source itself is a single item:
        # - For skills: directory contains SKILL.md
        # - For agents: directory contains .md files (agent definitions)
        # - For commands/rules/output-styles: would be a .md file, not a directory
        is_single_skill = category == "skills" and (source / "SKILL.md").exists()
        is_single_agent = category == "agents" and any(c.suffix == ".md" for c in children)

        if is_single_skill or is_single_agent:
            # Source is a single item
            items_to_add = [source]
        else:
            # Check if children look like items to add individually
            child_dirs = [c for c in children if c.is_dir()]
            child_mds = [c for c in children if c.suffix == ".md"]

            if category == "skills":
                # Add child directories that contain SKILL.md
                skill_dirs = [c for c in child_dirs if (c / "SKILL.md").exists()]
                items_to_add = skill_dirs if skill_dirs else [source]
            elif category == "agents":
                # Add child directories (agent groups)
                items_to_add = child_dirs if child_dirs else [source]
            else:
                # commands, rules, output-styles: add .md files and directories
                items_to_add = child_dirs + child_mds if (child_dirs or child_mds) else [source]
    else:
        # Single item (file)
        items_to_add = [source]

    added_count = 0
    skipped_count = 0

    for item in items_to_add:
        target = lib_dir / item.name
        if target.exists():
            print(f"  Skipped (exists): {category}/{item.name}")
            skipped_count += 1
            continue

        if item.is_dir():
            shutil.copytree(item, target)
        else:
            shutil.copy2(item, target)

        config[category][item.name] = True
        added_count += 1
        print(f"  Added: {category}/{item.name}")

    save_config(config)
    sync_category(category, config)

    if added_count > 0:
        print(f"Added and enabled {added_count} items in {category}/")
    if skipped_count > 0:
        print(f"Skipped {skipped_count} existing items")


def print_usage() -> None:
    """Print usage information."""
    print("""claude-config - Manage Claude Code skills, commands, agents, rules, and output-styles

Usage:
  claude-config sync                    Sync symlinks based on enabled.json
  claude-config list [CATEGORY]         List items and their status
  claude-config enable CATEGORY ITEM    Enable an item (use * for all)
  claude-config disable CATEGORY ITEM   Disable an item (use * for all)
  claude-config add CATEGORY PATH       Add a new item from source path

Categories: skills, commands, agents, rules, output-styles

Examples:
  claude-config list                    List all items
  claude-config list agents             List agents only
  claude-config disable agents business-product
  claude-config enable skills *         Enable all skills
  claude-config sync                    Apply configuration
""")


def main() -> None:
    if len(sys.argv) < 2:
        print_usage()
        sys.exit(0)

    cmd = sys.argv[1]

    if cmd == "sync":
        cmd_sync()
    elif cmd == "list":
        category = sys.argv[2] if len(sys.argv) > 2 else None
        cmd_list(category)
    elif cmd == "enable":
        if len(sys.argv) < 4:
            print("Usage: claude-config enable CATEGORY ITEM")
            sys.exit(1)
        cmd_enable(sys.argv[2], sys.argv[3])
    elif cmd == "disable":
        if len(sys.argv) < 4:
            print("Usage: claude-config disable CATEGORY ITEM")
            sys.exit(1)
        cmd_disable(sys.argv[2], sys.argv[3])
    elif cmd == "add":
        if len(sys.argv) < 4:
            print("Usage: claude-config add CATEGORY PATH")
            sys.exit(1)
        cmd_add(sys.argv[2], sys.argv[3])
    elif cmd in ["-h", "--help", "help"]:
        print_usage()
    else:
        print(f"Unknown command: {cmd}")
        print_usage()
        sys.exit(1)


if __name__ == "__main__":
    main()
