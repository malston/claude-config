#!/usr/bin/env bash
# ABOUTME: Switches ~/.claude symlink between config directories.
# ABOUTME: Usage: switch-claude-config [config-name|list] or no args to cycle.

set -euo pipefail

CLAUDE_DIR="$HOME/.claude"

# Check if a directory is a Claude config (has settings.json with enabledPlugins key)
is_claude_config() {
    local dir="$1"
    local settings="$dir/settings.json"
    [[ -f "$settings" ]] && grep -q '"enabledPlugins"' "$settings" 2>/dev/null
}

# Discover available configs
# Priority: CLAUDE_CONFIGS env var (colon-separated paths), then auto-detect in $HOME
get_available_configs() {
    local configs=()

    if [[ -n "${CLAUDE_CONFIGS:-}" ]]; then
        # Use explicitly configured paths
        IFS=':' read -ra paths <<< "$CLAUDE_CONFIGS"
        for path in "${paths[@]}"; do
            # Expand ~ if present
            path="${path/#\~/$HOME}"
            if [[ -d "$path" ]]; then
                configs+=("$path")
            fi
        done
    else
        # Fallback: scan hidden directories in $HOME for Claude configs
        for dir in "$HOME"/.*; do
            if [[ -d "$dir" && ! -L "$dir" && "$dir" != "$HOME/." && "$dir" != "$HOME/.." ]]; then
                if is_claude_config "$dir"; then
                    configs+=("$dir")
                fi
            fi
        done
    fi

    printf '%s\n' "${configs[@]}"
}

# Extract display name from config path
get_config_name() {
    local path="$1"
    basename "$path" | sed 's/^\.claude_config_//' | sed 's/^\.claude[-_]//'
}

get_current_config() {
    if [[ -L "$CLAUDE_DIR" ]]; then
        local target
        target=$(readlink "$CLAUDE_DIR")
        # Handle both relative and absolute symlinks
        if [[ "$target" != /* ]]; then
            target="$HOME/$target"
        fi
        echo "$target"
    else
        echo ""
    fi
}

show_usage() {
    local current
    current=$(get_current_config)

    echo "Usage: $0 [config-name|list]"
    echo "       Or run without args to cycle through configs"
    echo ""
    if [[ -n "${CLAUDE_CONFIGS:-}" ]]; then
        echo "Using CLAUDE_CONFIGS: $CLAUDE_CONFIGS"
    else
        echo "Auto-detecting Claude configs in \$HOME (directories with settings.json)"
        echo "Set CLAUDE_CONFIGS to specify explicit paths (colon-separated)"
    fi
    echo ""
    echo "Available configs:"
    while IFS= read -r cfg; do
        local name
        name=$(get_config_name "$cfg")
        if [[ "$cfg" == "$current" ]]; then
            printf "  * %-12s %s\n" "$name" "$cfg"
        else
            printf "    %-12s %s\n" "$name" "$cfg"
        fi
    done < <(get_available_configs)
}

# Find config path by name (searches available configs)
find_config_path() {
    local search="$1"
    while IFS= read -r cfg; do
        local name
        name=$(get_config_name "$cfg")
        if [[ "$name" == "$search" || "$cfg" == "$search" ]]; then
            echo "$cfg"
            return 0
        fi
    done < <(get_available_configs)
    return 1
}

switch_to() {
    local target="$1"
    local target_path

    # Check if it's already a valid path
    if [[ -d "$target" ]]; then
        target_path="$target"
    else
        # Try to find by name
        target_path=$(find_config_path "$target") || {
            echo "Error: Config '$target' not found" >&2
            echo "Run '$0 list' to see available configs" >&2
            return 1
        }
    fi

    ln -sfn "$target_path" "$CLAUDE_DIR"
    echo "Switched to $(get_config_name "$target_path") config"
    echo "~/.claude -> $(readlink "$CLAUDE_DIR")"
}

# Get available configs as array
mapfile -t configs < <(get_available_configs)

if [[ ${#configs[@]} -eq 0 ]]; then
    echo "Error: No Claude config directories found" >&2
    if [[ -n "${CLAUDE_CONFIGS:-}" ]]; then
        echo "Check your CLAUDE_CONFIGS paths: $CLAUDE_CONFIGS" >&2
    else
        echo "No directories with Claude settings.json found in \$HOME" >&2
        echo "Set CLAUDE_CONFIGS to specify explicit paths" >&2
    fi
    exit 1
fi

current=$(get_current_config)

if [[ $# -eq 0 ]]; then
    # Cycle mode: find current config index and switch to next
    if [[ ${#configs[@]} -eq 1 ]]; then
        echo "Only one config available: $(get_config_name "${configs[0]}")"
        exit 0
    fi

    current_idx=-1
    for i in "${!configs[@]}"; do
        if [[ "${configs[$i]}" == "$current" ]]; then
            current_idx=$i
            break
        fi
    done

    next_idx=$(( (current_idx + 1) % ${#configs[@]} ))
    switch_to "${configs[$next_idx]}"
else
    case "$1" in
        list|-l|--list)
            show_usage
            ;;
        -h|--help|help)
            show_usage
            ;;
        *)
            switch_to "$1"
            ;;
    esac
fi
